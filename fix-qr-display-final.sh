#!/bin/bash

echo "üîß ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ QR Code ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ - ÿßŸÑÿ≠ŸÑ ÿßŸÑŸÜŸáÿßÿ¶Ÿä"
echo "============================================="

cd /var/www/unitrans

echo ""
echo "üîç 1Ô∏è‚É£ ŸÅÿ≠ÿµ ÿßŸÑŸÖÿ¥ŸÉŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:"
echo "======================="

echo "üîç ŸÅÿ≠ÿµ generateQRCode function:"
grep -A 20 -B 5 "generateQRCode" frontend-new/app/student/portal/page.js

echo ""
echo "üîß 2Ô∏è‚É£ ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ QR Code ŸÖÿ®ÿßÿ¥ÿ±ÿ©:"
echo "============================="

# Fix the QR code display in the portal page
cat > /tmp/qr_display_final_fix.js << 'EOF'
        const generateQRCode = async () => {
          try {
            console.log('üîó Starting QR Code generation...');
            
            // Prepare real student data for QR code
            const realStudentData = {
              id: student?.id || user?.id || `student-${Date.now()}`,
              studentId: student?.studentId || user?.studentId || 'Not assigned',
              email: user?.email || student?.email || 'not@provided.com',
              fullName: student?.fullName || user?.fullName || 'Student',
              phoneNumber: student?.phoneNumber || user?.phoneNumber || 'Not provided',
              college: student?.college || user?.college || 'Not specified',
              grade: student?.grade || user?.grade || 'Not specified',
              major: student?.major || user?.major || 'Not specified',
              address: {
                streetAddress: student?.address?.streetAddress || 'Not provided',
                fullAddress: student?.address?.fullAddress || 'Not provided'
              }
            };

            console.log('üìù Sending real student data for QR generation:', realStudentData);

            const response = await fetch('/api/students/generate-qr', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ email: realStudentData.email })
            });

            console.log('üì° QR Generation response status:', response.status);
            const data = await response.json();
            console.log('üì° QR Generation response data:', data);
            
            if (data.success) {
              console.log('‚úÖ QR Code generated successfully!');
              
              // Create a new window/tab to show the QR code
              const qrWindow = window.open('', '_blank', 'width=600,height=700');
              
              if (qrWindow) {
                qrWindow.document.write(`
                  <!DOCTYPE html>
                  <html>
                  <head>
                    <title>Student QR Code</title>
                    <style>
                      body { 
                        font-family: Arial, sans-serif; 
                        padding: 20px; 
                        text-align: center; 
                        background: #f8f9fa;
                      }
                      .container {
                        max-width: 500px;
                        margin: 0 auto;
                        background: white;
                        padding: 30px;
                        border-radius: 10px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                      }
                      .student-info {
                        background: #e3f2fd;
                        padding: 20px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        text-align: left;
                      }
                      .qr-code {
                        margin: 20px 0;
                      }
                      .download-btn {
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-top: 15px;
                      }
                      .download-btn:hover {
                        background: #218838;
                      }
                    </style>
                  </head>
                  <body>
                    <div class="container">
                      <h1>üéì Student QR Code</h1>
                      
                      <div class="student-info">
                        <h3>Student Information</h3>
                        <p><strong>Name:</strong> ${realStudentData.fullName}</p>
                        <p><strong>Email:</strong> ${realStudentData.email}</p>
                        <p><strong>Student ID:</strong> ${realStudentData.studentId}</p>
                        <p><strong>Phone:</strong> ${realStudentData.phoneNumber}</p>
                        <p><strong>College:</strong> ${realStudentData.college}</p>
                        <p><strong>Grade:</strong> ${realStudentData.grade}</p>
                        <p><strong>Major:</strong> ${realStudentData.major}</p>
                        <p><strong>Address:</strong> ${realStudentData.address.streetAddress}, ${realStudentData.address.fullAddress}</p>
                      </div>
                      
                      <div class="qr-code">
                        <img src="${data.qrCode}" 
                             alt="Student QR Code" 
                             style="width: 300px; height: 300px; border: 2px solid #28a745; border-radius: 8px;" />
                      </div>
                      
                      <button class="download-btn" onclick="downloadQR()">üì• Download QR Code</button>
                    </div>
                    
                    <script>
                      function downloadQR() {
                        const link = document.createElement('a');
                        link.href = '${data.qrCode}';
                        link.download = 'student-qr-code-${Date.now()}.png';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        alert('QR code downloaded successfully!');
                      }
                    </script>
                  </body>
                  </html>
                `);
                qrWindow.document.close();
                console.log('‚úÖ QR Code window opened successfully!');
              } else {
                console.error('‚ùå Failed to open QR Code window');
                alert('Failed to open QR Code window. Please check your popup blocker settings.');
              }
            } else {
              console.error('‚ùå QR Code generation failed:', data.message);
              alert('Failed to generate QR code: ' + data.message);
            }
          } catch (error) {
            console.error('‚ùå Error generating QR code:', error);
            alert('Error generating QR code: ' + error.message);
          }
        };
EOF

# Replace the generateQRCode function
sed -i '/const generateQRCode = async () => {/,/^  };$/c\
        const generateQRCode = async () => {\
          try {\
            console.log('\''üîó Starting QR Code generation...'\'');\
            \
            // Prepare real student data for QR code\
            const realStudentData = {\
              id: student?.id || user?.id || `student-${Date.now()}`,\
              studentId: student?.studentId || user?.studentId || '\''Not assigned'\'',\
              email: user?.email || student?.email || '\''not@provided.com'\'',\
              fullName: student?.fullName || user?.fullName || '\''Student'\'',\
              phoneNumber: student?.phoneNumber || user?.phoneNumber || '\''Not provided'\'',\
              college: student?.college || user?.college || '\''Not specified'\'',\
              grade: student?.grade || user?.grade || '\''Not specified'\'',\
              major: student?.major || user?.major || '\''Not specified'\'',\
              address: {\
                streetAddress: student?.address?.streetAddress || '\''Not provided'\'',\
                fullAddress: student?.address?.fullAddress || '\''Not provided'\''\
              }\
            };\
\
            console.log('\''üìù Sending real student data for QR generation:'\'' + JSON.stringify(realStudentData));\
\
            const response = await fetch('\''/api/students/generate-qr'\'', {\
              method: '\''POST'\'',\
              headers: {\
                '\''Content-Type'\'': '\''application/json'\'',\
              },\
              body: JSON.stringify({ email: realStudentData.email })\
            });\
\
            console.log('\''üì° QR Generation response status:'\'' + response.status);\
            const data = await response.json();\
            console.log('\''üì° QR Generation response data:'\'' + JSON.stringify(data));\
            \
            if (data.success) {\
              console.log('\''‚úÖ QR Code generated successfully!'\'');\
              \
              // Create a new window/tab to show the QR code\
              const qrWindow = window.open('\'''\''', '\''_blank'\'', '\''width=600,height=700'\'');\
              \
              if (qrWindow) {\
                qrWindow.document.write(`\
                  <!DOCTYPE html>\
                  <html>\
                  <head>\
                    <title>Student QR Code</title>\
                    <style>\
                      body { \
                        font-family: Arial, sans-serif; \
                        padding: 20px; \
                        text-align: center; \
                        background: #f8f9fa;\
                      }\
                      .container {\
                        max-width: 500px;\
                        margin: 0 auto;\
                        background: white;\
                        padding: 30px;\
                        border-radius: 10px;\
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);\
                      }\
                      .student-info {\
                        background: #e3f2fd;\
                        padding: 20px;\
                        border-radius: 8px;\
                        margin-bottom: 20px;\
                        text-align: left;\
                      }\
                      .qr-code {\
                        margin: 20px 0;\
                      }\
                      .download-btn {\
                        background: #28a745;\
                        color: white;\
                        border: none;\
                        padding: 12px 24px;\
                        border-radius: 6px;\
                        cursor: pointer;\
                        font-size: 16px;\
                        margin-top: 15px;\
                      }\
                      .download-btn:hover {\
                        background: #218838;\
                      }\
                    </style>\
                  </head>\
                  <body>\
                    <div class="container">\
                      <h1>üéì Student QR Code</h1>\
                      \
                      <div class="student-info">\
                        <h3>Student Information</h3>\
                        <p><strong>Name:</strong> ${realStudentData.fullName}</p>\
                        <p><strong>Email:</strong> ${realStudentData.email}</p>\
                        <p><strong>Student ID:</strong> ${realStudentData.studentId}</p>\
                        <p><strong>Phone:</strong> ${realStudentData.phoneNumber}</p>\
                        <p><strong>College:</strong> ${realStudentData.college}</p>\
                        <p><strong>Grade:</strong> ${realStudentData.grade}</p>\
                        <p><strong>Major:</strong> ${realStudentData.major}</p>\
                        <p><strong>Address:</strong> ${realStudentData.address.streetAddress}, ${realStudentData.address.fullAddress}</p>\
                      </div>\
                      \
                      <div class="qr-code">\
                        <img src="${data.qrCode}" \
                             alt="Student QR Code" \
                             style="width: 300px; height: 300px; border: 2px solid #28a745; border-radius: 8px;" />\
                      </div>\
                      \
                      <button class="download-btn" onclick="downloadQR()">üì• Download QR Code</button>\
                    </div>\
                    \
                    <script>\
                      function downloadQR() {\
                        const link = document.createElement('\''a'\'');\
                        link.href = '\''${data.qrCode}'\'';\
                        link.download = '\''student-qr-code-${Date.now()}.png'\'';\
                        document.body.appendChild(link);\
                        link.click();\
                        document.body.removeChild(link);\
                        alert('\''QR code downloaded successfully!'\'');\
                      }\
                    </script>\
                  </body>\
                  </html>\
                `);\
                qrWindow.document.close();\
                console.log('\''‚úÖ QR Code window opened successfully!'\'');\
              } else {\
                console.error('\''‚ùå Failed to open QR Code window'\'');\
                alert('\''Failed to open QR Code window. Please check your popup blocker settings.'\'');\
              }\
            } else {\
              console.error('\''‚ùå QR Code generation failed:'\'' + data.message);\
              alert('\''Failed to generate QR code: '\'' + data.message);\
            }\
          } catch (error) {\
            console.error('\''‚ùå Error generating QR code:'\'' + error);\
            alert('\''Error generating QR code: '\'' + error.message);\
          }\
        };' frontend-new/app/student/portal/page.js

echo "‚úÖ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ QR Code ŸÅŸä Portal"

echo ""
echo "üîß 3Ô∏è‚É£ ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ Frontend:"
echo "========================="

echo "üîÑ ÿ•ŸäŸÇÿßŸÅ frontend..."
pm2 stop unitrans-frontend

echo "‚è≥ ÿßŸÜÿ™ÿ∏ÿßÿ± 5 ÿ´ŸàÿßŸÜŸä..."
sleep 5

echo "üîÑ ÿ≠ÿ∞ŸÅ frontend process..."
pm2 delete unitrans-frontend

echo "‚è≥ ÿßŸÜÿ™ÿ∏ÿßÿ± 5 ÿ´ŸàÿßŸÜŸä..."
sleep 5

echo "üîÑ ÿ®ÿØÿ° frontend ÿ¨ÿØŸäÿØ..."
cd frontend-new
pm2 start npm --name "unitrans-frontend" -- start

echo "‚è≥ ÿßŸÜÿ™ÿ∏ÿßÿ± 30 ÿ´ÿßŸÜŸäÿ© ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ..."
sleep 30

echo "üîç ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© frontend:"
pm2 status unitrans-frontend

echo ""
echo "üéâ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ QR Code ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠!"
echo "üåê ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßÿÆÿ™ÿ®ÿßÿ±:"
echo "   üîó https://unibus.online/student/portal"
echo "   ‚úÖ QR Code Generation ŸäÿπŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠"
echo "   ‚úÖ QR Code Ÿäÿ∏Ÿáÿ± ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ©"
echo "   ‚úÖ ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸÖŸäŸÑ QR Code"
echo "   ‚úÖ ÿßŸÑÿ™ÿµŸÖŸäŸÖ ŸÑŸÖ Ÿäÿ™ÿ£ÿ´ÿ±"
